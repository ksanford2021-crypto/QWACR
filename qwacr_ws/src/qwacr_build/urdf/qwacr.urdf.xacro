<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="qwacr">
  <!-- Arguments -->
  <xacro:arg name="use_gazebo" default="false"/>
  <xacro:arg name="serial_port" default="/tmp/ttyV0"/>
  <xacro:arg name="baud_rate" default="115200"/>

  <!-- Base -->
  <link name="base_link">
    <visual>
      <origin xyz="0 0 .1" rpy="0 0 0"/>
      <geometry>
        <box size=".45 .3 .2"/>
      </geometry>
      <material name="blue">
        <color rgba="0 0 1 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 .1" rpy="0 0 0"/>
      <geometry>
        <box size=".45 .3 .2"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="25.0"/>
      <inertia ixx="0.05" ixy="0.0" ixz="0.0" iyy="0.06" iyz="0.0" izz="0.07"/>
    </inertial>
  </link>

  <gazebo reference="base_link">
    <material>Gazebo/Blue</material>
  </gazebo>

  <!-- Front left wheel -->
  <joint name="base_to_front_left_wheel" type="continuous">
    <parent link="base_link"/>
    <child link="front_left_wheel_link"/>
    <origin xyz="0.18 0.19 -0.02" rpy="0 0 0"/>
     <axis xyz="0 1 0"/>
    <limit effort="6.2" velocity="104"/>
    <dynamics damping=".0001" friction="0.001"/>
  </joint>
  <link name="front_left_wheel_link">
    <visual>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.165" length="0.06"/>
      </geometry>
      <material name="red">
        <color rgba="1 0 0 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.165" length="0.06"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="1.0"/>
      <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
    </inertial>
  </link>

  <gazebo reference="front_left_wheel_link">
    <material>Gazebo/Red</material>
  </gazebo>

  <!-- Front right wheel -->
  <joint name="base_to_front_right_wheel" type="continuous">
    <parent link="base_link"/>
    <child link="front_right_wheel_link"/>
    <origin xyz="0.18 -0.19 -0.02" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
    <limit effort="6.2" velocity="104"/>
    <dynamics damping=".0001" friction="0.001"/>
  </joint>
  <link name="front_right_wheel_link">
    <visual>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.165" length="0.06"/>
      </geometry>
      <material name="green">
        <color rgba="0 1 0 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.165" length="0.06"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="1.0"/>
      <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
    </inertial>
  </link>

  <gazebo reference="front_right_wheel_link">
    <material>Gazebo/Green</material>
  </gazebo>

  <!-- Back left wheel -->
  <joint name="base_to_back_left_wheel" type="continuous">
    <parent link="base_link"/>
    <child link="back_left_wheel_link"/>
    <origin xyz="-0.18 0.19 -0.02" rpy="0 0 0"/>
     <axis xyz="0 1 0"/>
    <limit effort="6.2" velocity="104"/>
    <dynamics damping=".0001" friction="0.001"/>
  </joint>
  <link name="back_left_wheel_link">
    <visual>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.165" length="0.06"/>
      </geometry>
      <material name="yellow">
        <color rgba="1 1 0 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.165" length="0.06"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="3.0"/>
      <inertia ixx="0.002" ixy="0.0" ixz="0.0" iyy="0.002" iyz="0.0" izz="0.002"/>
    </inertial>
  </link>

  <gazebo reference="back_left_wheel_link">
    <material>Gazebo/Yellow</material>
  </gazebo>

  <!-- Back right wheel -->
  <joint name="base_to_back_right_wheel" type="continuous">
    <parent link="base_link"/>
    <child link="back_right_wheel_link"/>
    <origin xyz="-0.18 -0.19 -0.02" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
    <limit effort="6.2" velocity="104"/>
    <dynamics damping=".0001" friction="0.001"/>
  </joint>
  <link name="back_right_wheel_link">
    <visual>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.165" length="0.06"/>
      </geometry>
      <material name="purple">
        <color rgba="1 0 1 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder radius="0.165" length="0.06"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="3.0"/>
      <inertia ixx="0.002" ixy="0.0" ixz="0.0" iyy="0.002" iyz="0.0" izz="0.002"/>
    </inertial>
  </link>

  <gazebo reference="back_right_wheel_link">
    <material>Gazebo/Purple</material>
  </gazebo>

  <!-- Sensor Tower (35cm tall) -->
  <link name="sensor_tower">
    <visual>
      <origin xyz="0 0 0.175" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.025" length="0.35"/>
      </geometry>
      <material name="silver">
        <color rgba="0.75 0.75 0.75 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0.175" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.025" length="0.35"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="0.2"/>
      <inertia ixx="0.0001" ixy="0.0" ixz="0.0" iyy="0.0001" iyz="0.0" izz="0.00005"/>
    </inertial>
  </link>

  <joint name="base_to_sensor_tower" type="fixed">
    <parent link="base_link"/>
    <child link="sensor_tower"/>
    <origin xyz="0.0 0.0 0.1" rpy="0 0 0"/>
  </joint>

  <!-- GPS Module (LG580P board at base level) -->
  <link name="gps_module">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.08 0.06 0.02"/>
      </geometry>
      <material name="black">
        <color rgba="0 0 0 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.08 0.06 0.02"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="0.15"/>
      <inertia ixx="0.00002" ixy="0.0" ixz="0.0" iyy="0.00003" iyz="0.0" izz="0.00002"/>
    </inertial>
  </link>

  <joint name="base_to_gps_module" type="fixed">
    <parent link="base_link"/>
    <child link="gps_module"/>
    <origin xyz="-0.1 0.0 0.11" rpy="0 0 0"/>
  </joint>

  <!-- GPS Reference Frame (antenna midpoint at tower top) -->
  <!-- Dual antennas at Â±10cm Y, midpoint defines position measurement -->
  <!-- Frame for GPS driver to publish position and heading -->
  <link name="gps_link">
    <inertial>
      <mass value="0.001"/>
      <inertia ixx="0.000001" ixy="0.0" ixz="0.0" iyy="0.000001" iyz="0.0" izz="0.000001"/>
    </inertial>
  </link>

  <joint name="tower_to_gps" type="fixed">
    <parent link="sensor_tower"/>
    <child link="gps_link"/>
    <origin xyz="0.0 0.0 0.35" rpy="0 0 0"/>
  </joint>

  <!-- LiDAR Sensor Link (SLAMTEC Aurora, mounted at top of tower) -->
  <link name="laser_frame">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.04" length="0.025"/>
      </geometry>
      <material name="darkgrey">
        <color rgba="0.2 0.2 0.2 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.04" length="0.025"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="0.225"/>
      <inertia ixx="0.0001" ixy="0.0" ixz="0.0" iyy="0.0001" iyz="0.0" izz="0.0001"/>
    </inertial>
  </link>

  <joint name="tower_to_laser" type="fixed">
    <parent link="sensor_tower"/>
    <child link="laser_frame"/>
    <origin xyz="0.0 0.0 0.35" rpy="0 0 0"/>
  </joint>

  <!-- ros2_control: use hardware plugin with serial simulator for development -->
  <xacro:unless value="$(arg use_gazebo)">
    <ros2_control name="MegaDiffDriveHardware" type="system">
      <hardware>
        <plugin>mega_diff_drive_control/MegaDiffDriveHardware</plugin>
        <param name="serial_port">$(arg serial_port)</param>
        <param name="baud_rate">$(arg baud_rate)</param>
      </hardware>
      <joint name="base_to_front_left_wheel">
        <command_interface name="velocity"/>
        <state_interface name="velocity"/>
        <state_interface name="position"/>
      </joint>
      <joint name="base_to_front_right_wheel">
        <command_interface name="velocity"/>
        <state_interface name="velocity"/>
        <state_interface name="position"/>
      </joint>
      <joint name="base_to_back_left_wheel">
        <command_interface name="velocity"/>
        <state_interface name="velocity"/>
        <state_interface name="position"/>
      </joint>
      <joint name="base_to_back_right_wheel">
        <command_interface name="velocity"/>
        <state_interface name="velocity"/>
        <state_interface name="position"/>
      </joint>
    </ros2_control>
  </xacro:unless>

  <!-- Gazebo simulation mode: use Gazebo physics directly -->
  <xacro:if value="$(arg use_gazebo)">
    <ros2_control name="GazeboSystem" type="system">
      <hardware>
        <plugin>gz_ros2_control/GazeboSimSystem</plugin>
      </hardware>
      <joint name="base_to_front_left_wheel">
        <command_interface name="velocity"/>
        <state_interface name="velocity"/>
        <state_interface name="position"/>
      </joint>
      <joint name="base_to_front_right_wheel">
        <command_interface name="velocity"/>
        <state_interface name="velocity"/>
        <state_interface name="position"/>
      </joint>
      <joint name="base_to_back_left_wheel">
        <command_interface name="velocity"/>
        <state_interface name="velocity"/>
        <state_interface name="position"/>
      </joint>
      <joint name="base_to_back_right_wheel">
        <command_interface name="velocity"/>
        <state_interface name="velocity"/>
        <state_interface name="position"/>
      </joint>
    </ros2_control>
  </xacro:if>

  <!-- Gazebo plugin to bridge ros2_control to Gazebo physics -->
  <xacro:if value="$(arg use_gazebo)">
    <gazebo>
      <plugin filename="libgz_ros2_control-system.so" name="gz_ros2_control::GazeboSimROS2ControlPlugin">
        <parameters>$(find qwacr_build)/config/diff_drive_controller.yaml</parameters>
      </plugin>
    </gazebo>
  </xacro:if>

</robot>
